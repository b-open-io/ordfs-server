import e from"http-errors";import{Tx as t,Script as r,OpCode as n}from"@ts-bitcoin/core";import{Transaction as o}from"bitcore-lib";import*as i from"dns/promises";import s from"cross-fetch";import{JungleBusClient as c}from"@gorillapool/js-junglebus";import*as u from"bitcoin-core";import{Redis as a}from"ioredis";function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function f(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?h(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var l;if(process.env.REDIS_HOST){var v=process.env.REDIS_HOST,m=process.env.REDIS_PORT?parseInt(process.env.REDIS_PORT,10):6379;console.log("Connecting to redis:",v,m),l=new a(m,v)}var p=/*#__PURE__*/function(){function t(e,t,r,n,o){this.network=void 0,this.client=void 0,this.network=e,this.client=new u({host:t,port:r,username:n,password:o})}var r=t.prototype;return r.getRawTx=function(t){try{var r,n=this;return Promise.resolve(null==(r=l)?void 0:r.getBuffer("rawtx:"+t)).then(function(r){var o=function(){if(!r)return Promise.resolve(n.client.getTransactionByHash(t,{extension:"bin"})).then(function(n){var o;if(!(r=n))throw new e.NotFound;null==(o=l)||o.set("rawtx:"+t,r)})}();return o&&o.then?o.then(function(e){return r}):r})}catch(e){return Promise.reject(e)}},r.getBlockchainInfo=function(){try{return Promise.resolve(this.client.getBlockchainInfo()).then(function(e){return{height:e.blocks,hash:e.bestblockhash}})}catch(e){return Promise.reject(e)}},r.getBlockByHeight=function(e){try{return Promise.resolve(this.client.getBlockHash(e)).then(function(t){return{height:e,hash:t}})}catch(e){return Promise.reject(e)}},r.getBlockByHash=function(e){try{return Promise.resolve(this.client.getBlockHeader(e)).then(function(t){return{height:t.height,hash:e}})}catch(e){return Promise.reject(e)}},t}(),g=/*#__PURE__*/function(){function t(){this.network="bsv"}var r=t.prototype;return r.getRawTx=function(e){try{var t;return Promise.resolve(null==(t=l)?void 0:t.getBuffer("rawtx:"+e)).then(function(t){var r=function(){if(!t){var r=new c("https://junglebus.gorillapool.io");return Promise.resolve(r.GetTransaction(e)).then(function(r){var n;t=Buffer.from(r.transaction,"base64"),null==(n=l)||n.set("rawtx:"+e,t)})}}();return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}},r.getBlockchainInfo=function(){try{return Promise.resolve(s("https://api.whatsonchain.com/v1/bsv/main/block/headers")).then(function(t){if(!t.ok)throw e(t.status,t.statusText);return Promise.resolve(t.json()).then(function(e){return{height:e[0].height,hash:e[0].hash}})})}catch(e){return Promise.reject(e)}},r.getBlockByHeight=function(e){try{return Promise.resolve(s("https://api.whatsonchain.com/v1/bsv/main/block/height/"+e)).then(function(t){return Promise.resolve(t.json()).then(function(t){return{height:e,hash:t.hash}})})}catch(e){return Promise.reject(e)}},r.getBlockByHash=function(e){try{return Promise.resolve(s("https://api.whatsonchain.com/v1/bsv/main/block/hash/"+e)).then(function(t){return Promise.resolve(t.json()).then(function(t){return{height:t.height,hash:e}})})}catch(e){return Promise.reject(e)}},t}(),d=/*#__PURE__*/function(){function t(){this.network="btc"}var r=t.prototype;return r.getRawTx=function(t){try{var r;return Promise.resolve(null==(r=l)?void 0:r.getBuffer("rawtx:"+t)).then(function(r){var n=function(){if(!r)return Promise.resolve(s("https://ordinals.shruggr.cloud/v1/btc/tx/"+t)).then(function(n){if(!n.ok)throw e(n.status,n.statusText);var o=Buffer,i=o.from;return Promise.resolve(n.arrayBuffer()).then(function(e){var n;r=i.call(o,e),null==(n=l)||n.set("rawtx:"+t,r)})})}();return n&&n.then?n.then(function(e){return r}):r})}catch(e){return Promise.reject(e)}},r.getBlockchainInfo=function(){try{return Promise.resolve(s("https://ordinals.shruggr.cloud/v1/btc/block/latest")).then(function(t){if(!t.ok)throw e(t.status,t.statusText);return t.json()})}catch(e){return Promise.reject(e)}},r.getBlockByHeight=function(e){try{return Promise.resolve(s("https://ordinals.shruggr.cloud/v1/btc/block/height/"+e)).then(function(t){return Promise.resolve(t.json()).then(function(t){return{height:e,hash:t.hash}})})}catch(e){return Promise.reject(e)}},r.getBlockByHash=function(e){try{return Promise.resolve(s("https://ordinals.shruggr.cloud/v1/btc/block/hash/"+e)).then(function(t){return Promise.resolve(t.json()).then(function(t){return{height:t.height,hash:e}})})}catch(e){return Promise.reject(e)}},t}(),P=function(n,i){void 0===i&&(i=!1);try{var c,u=function(t){if(!c)throw new e.NotFound;return c};console.log("loadInscription",n);var a=function(){if(n.match(/^[0-9a-fA-F]{64}_\d*$/)){var u=n.split("_"),a=u[0],h=u[1];return console.log("BSV:",a,h),Promise.resolve(x.getRawTx(a)).then(function(r){if(!r)throw new Error("No raw tx found");var o=t.fromBuffer(r),u=parseInt(h,10),f=o.txOuts[u].script;if(!f)throw new e.NotFound;c=S(f);var l=function(){if(c&&i){var e=function(e,t){try{var r=Promise.resolve(s("https://ordinals.gorillapool.io/api/inscriptions/outpoint/"+n)).then(function(e){return Promise.resolve(e.json()).then(function(e){return Promise.resolve(x.getBlockByHeight(e.height)).then(function(t){c.meta={height:e.height,MAP:e.MAP,hash:t.hash,txid:a,v:u}})})})}catch(e){return}return r&&r.then?r.then(void 0,function(){}):r}();if(e&&e.then)return e.then(function(){})}}();if(l&&l.then)return l.then(function(){})})}return function(){if(n.match(/^[0-9a-fA-F]{64}i\d+$/)&&N){var t=n.split("i"),i=t[0],s=t[1];return console.log("BTC",i,s),Promise.resolve(N.getRawTx(i)).then(function(t){if(!t)throw new Error("No raw tx found");var n=new o(t),i=r.fromBuffer(n.inputs[parseInt(s,10)].witnesses[1]);if(!i)throw new e.NotFound;c=S(i)})}throw new Error("Invalid Pointer")}()}();return Promise.resolve(a&&a.then?a.then(u):u())}catch(e){return Promise.reject(e)}},w=function(t){try{var r="_ordfs."+t;return Promise.resolve(i.resolveTxt(r)).then(function(t){var n="";console.log("Lookup Up:",r);e:for(var o,i=f(t);!(o=i()).done;){for(var s,c=f(o.value);!(s=c()).done;){var u=s.value;if(u.startsWith("ordfs=")){console.log("Elem:",u),n=u.slice(6),console.log("Origin:",n);break e}}if(!n)throw new e.NotFound}return n})}catch(e){return Promise.reject(e)}},y=function(t,r){try{switch(t){case"btc":return Promise.resolve(N.getRawTx(r));case"bsv":return Promise.resolve(x.getRawTx(r));default:throw new e.NotFound("Network Not Found")}}catch(e){return Promise.reject(e)}},b=function(t,r){try{switch(t){case"btc":return Promise.resolve(N.getBlockByHash(r));case"bsv":return Promise.resolve(x.getBlockByHash(r));default:throw new e.NotFound("Network Not Found")}}catch(e){return Promise.reject(e)}},k=function(t,r){try{switch(t){case"btc":return Promise.resolve(N.getBlockByHeight(r));case"bsv":return Promise.resolve(x.getBlockByHeight(r));default:throw new e.NotFound("Network Not Found")}}catch(e){return Promise.reject(e)}},B=function(t){try{switch(t){case"btc":return Promise.resolve(N.getBlockchainInfo());case"bsv":return Promise.resolve(x.getBlockchainInfo());default:throw new e.NotFound("Network Not Found")}}catch(e){return Promise.reject(e)}},j=Buffer.from("19HxigV4QyBv3tHpQVcUEQyq1pzZVdoAut"),T=Buffer.from("ord"),N=new d,x=new g;function S(e){for(var t,r=0,o=0,i=0,s="application/octet-stream",c=Buffer.alloc(0),u=f(e.chunks.entries());!(t=u()).done;){var a,h,l=t.value,v=l[0],m=l[1];if(null!=(a=m.buf)&&a.equals(j)&&e.chunks.length>v+2)return{data:c=e.chunks[v+1].buf,type:s=e.chunks[v+2].buf.toString()};if(m.opCodeNum===n.OP_FALSE&&(r=v),m.opCodeNum===n.OP_IF&&(o=v),null!=(h=m.buf)&&h.equals(T)&&r===v-2&&o===v-1){i=v;break}}for(var p=i+1;p<e.chunks.length;p++)switch(e.chunks[p].opCodeNum){case n.OP_FALSE:for(;(null==(g=e.chunks[p+1])?void 0:g.opCodeNum)>=1&&(null==(d=e.chunks[p+1])?void 0:d.opCodeNum)<=n.OP_PUSHDATA4;){var g,d;c=Buffer.concat([c,e.chunks[p+1].buf]),p++}break;case 1:if(1!=e.chunks[p].buf[0])return;case n.OP_TRUE:s=e.chunks[p+1].buf.toString("utf8"),p++;break;case n.OP_ENDIF:return{type:s,data:c};default:return}return{type:s,data:c}}function I(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}function O(e,t,r){void 0===r&&(r=!0),t.header("Content-Type",e.type||""),e.meta&&t.header("ordfs-meta",JSON.stringify(e.meta)),r&&!e.meta&&t.header("Cache-Control","public,immutable,max-age=31536000"),t.status(200).send(e.data)}function H(t){var r=function(t,r,n){try{return Promise.resolve(I(function(){var n=t.params.pointer,o=t.params.filename;return Promise.resolve(P(n)).then(function(i){var s=JSON.parse(i.data.toString("utf8"));if(!s[o])throw new e.NotFound;return n=s[o].startsWith("ord://")?s[o].slice(6):s[o],Promise.resolve(P(n,t.query.meta)).then(function(e){O(e,r,!0)})})},function(e){n(e)}))}catch(e){return Promise.reject(e)}};t.get("/",function(e,t){try{var r,n,o=function(o){return r?o:I(function(){return Promise.resolve(P(n)).then(function(r){var n;"ord-fs/json"!==r.type||e.query.raw?O(r,t,!1):null==(n=e.res)||n.redirect("index.html")})},function(){t.render("pages/404")})},i=I(function(){return Promise.resolve(w(e.hostname)).then(function(e){n=e})},function(){t.render("pages/index"),r=1});return Promise.resolve(i&&i.then?i.then(o):o(i))}catch(e){return Promise.reject(e)}}),t.get("/v1/:network/block/latest",function(e,t,r){try{var n=I(function(){var r=t.json;return Promise.resolve(B(e.params.network)).then(function(e){r.call(t,e)})},function(e){r(e)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),t.get("/v1/:network/block/height/:height",function(e,t,r){try{var n=I(function(){var r=t.json;return Promise.resolve(k(e.params.network,parseInt(e.params.height,10))).then(function(e){r.call(t,e)})},function(e){r(e)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),t.get("/v1/:network/block/hash/:hash",function(e,t,r){try{var n=I(function(){var r=t.json;return Promise.resolve(b(e.params.network,e.params.hash)).then(function(e){r.call(t,e)})},function(e){r(e)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),t.get("/v1/:network/tx/:txid",function(e,t){try{t.set("Content-type","application/octet-stream");var r=t.send;return Promise.resolve(y(e.params.network,e.params.txid)).then(function(e){r.call(t,e)})}catch(e){return Promise.reject(e)}}),t.get("/:filename",function(t,r,n){try{var o,i=t.params.filename;return Promise.resolve(I(function(){function n(e){if(o)return e;O(c,r,u)}var s,c,u=!0,a=I(function(){return Promise.resolve(P(i,t.query.meta)).then(function(e){var r;"ord-fs/json"!==(c=e).type||t.query.raw||(null==(r=t.res)||r.redirect("/"+i+"/index.html"),o=1)})},function(r){return console.error("Outpoint Error",i,r.message),Promise.resolve(w(t.hostname)).then(function(r){return s=r,Promise.resolve(P(s)).then(function(r){var n=JSON.parse(r.data.toString("utf8"));if(!n[i])throw new e.NotFound;return s=n[i].slice(6),Promise.resolve(P(s,t.query.meta)).then(function(e){c=e,u=!1})})})});return a&&a.then?a.then(n):n(a)},function(e){n(e)}))}catch(e){return Promise.reject(e)}}),t.get("/content/:pointer",function(e,t,r){try{var n=e.params.pointer;return Promise.resolve(I(function(){return Promise.resolve(P(n,e.query.meta)).then(function(r){var o;"ord-fs/json"!==r.type||e.query.raw?O(r,t,!0):null==(o=e.res)||o.redirect("/"+n+"/index.html")})},function(e){r(e)}))}catch(e){return Promise.reject(e)}}),t.get("/preview/:b64HtmlData",function(e,t,r){try{try{var n=Buffer.from(e.params.b64HtmlData,"base64").toString("utf8");t.render("pages/preview",{htmlData:n})}catch(e){r(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}}),t.get("/:pointer/:filename",r),t.get("/content/:pointer/:filename",r)}process.env.BITCOIN_HOST&&(x=new p("bsv",process.env.BITCOIN_HOST||"",process.env.BITCOIN_PORT||"8332",process.env.BITCOIN_USER||"",process.env.BITCOIN_PASS||"")),process.env.BTC_HOST&&(N=new p("btc",process.env.BTC_HOST||"",process.env.BTC_PORT||"8332",process.env.BTC_USER||"",process.env.BTC_PASS||""));export{H as RegisterRoutes,b as getBlockByHash,k as getBlockByHeight,B as getLatestBlock,y as getRawTx,P as loadInscription,w as loadPointerFromDNS,S as parseScript};
//# sourceMappingURL=index.module.js.map
