import e from"http-errors";import{Tx as r,OpCode as t}from"@ts-bitcoin/core";import*as n from"dns/promises";import o from"cross-fetch";import{JungleBusClient as i}from"@gorillapool/js-junglebus";import{Redis as u}from"ioredis";function s(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function a(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=function(e,r){if(e){if("string"==typeof e)return s(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?s(e,r):void 0}}(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c;if(process.env.REDIS_HOST){var h=process.env.REDIS_HOST,f=process.env.REDIS_PORT?parseInt(process.env.REDIS_PORT,10):6379;console.log("Connecting to redis:",h,f),c=new u(f,h)}var l=/*#__PURE__*/function(){function r(){this.network="bsv"}var t=r.prototype;return t.getRawTx=function(e){try{var r;return Promise.resolve(null==(r=c)?void 0:r.getBuffer("rawtx:"+e)).then(function(r){var t=function(){if(!r){var t=new i("https://junglebus.gorillapool.io");return Promise.resolve(t.GetTransaction(e)).then(function(t){var n;r=Buffer.from(t.transaction,"base64"),null==(n=c)||n.set("rawtx:"+e,r)})}}();return t&&t.then?t.then(function(){return r}):r})}catch(e){return Promise.reject(e)}},t.getBlockchainInfo=function(){try{return Promise.resolve(o("https://api.whatsonchain.com/v1/bsv/main/block/headers")).then(function(r){if(!r.ok)throw e(r.status,r.statusText);return Promise.resolve(r.json()).then(function(e){return{height:e[0].height,hash:e[0].hash}})})}catch(e){return Promise.reject(e)}},t.getBlockByHeight=function(e){try{return Promise.resolve(o("https://api.whatsonchain.com/v1/bsv/main/block/height/"+e)).then(function(r){return Promise.resolve(r.json()).then(function(r){return{height:e,hash:r.hash}})})}catch(e){return Promise.reject(e)}},t.getBlockByHash=function(e){try{return Promise.resolve(o("https://api.whatsonchain.com/v1/bsv/main/block/hash/"+e)).then(function(r){return Promise.resolve(r.json()).then(function(r){return{height:r.height,hash:e}})})}catch(e){return Promise.reject(e)}},r}(),m=function(t,n){void 0===n&&(n=!1);try{var i,u=function(r){if(!i)throw new e.NotFound;return i};console.log("loadInscription",t);var s=function(){if(t.match(/^[0-9a-fA-F]{64}_\d*$/)){var u=t.split("_"),s=u[0],a=u[1];return console.log("BSV:",s,a),Promise.resolve(b.getRawTx(s)).then(function(u){if(!u)throw new Error("No raw tx found");var c=r.fromBuffer(u),h=parseInt(a,10),f=c.txOuts[h].script;if(!f)throw new e.NotFound;i=k(f);var l=function(){if(i&&n){var e=function(e,r){try{var n=Promise.resolve(o("https://ordinals.gorillapool.io/api/inscriptions/outpoint/"+t)).then(function(e){return Promise.resolve(e.json()).then(function(e){return Promise.resolve(b.getBlockByHeight(e.height)).then(function(r){i.meta={height:e.height,MAP:e.MAP,hash:r.hash,txid:s,v:h}})})})}catch(e){return}return n&&n.then?n.then(void 0,function(){}):n}();if(e&&e.then)return e.then(function(){})}}();if(l&&l.then)return l.then(function(){})})}throw new Error("Invalid Pointer")}();return Promise.resolve(s&&s.then?s.then(u):u())}catch(e){return Promise.reject(e)}},v=function(r){try{var t="_ordfs."+r;return Promise.resolve(n.resolveTxt(t)).then(function(r){var n="";console.log("Lookup Up:",t);e:for(var o,i=a(r);!(o=i()).done;){for(var u,s=a(o.value);!(u=s()).done;){var c=u.value;if(c.startsWith("ordfs=")){console.log("Elem:",c),n=c.slice(6),console.log("Origin:",n);break e}}if(!n)throw new e.NotFound}return n})}catch(e){return Promise.reject(e)}},p=function(r,t){try{if("bsv"===r)return Promise.resolve(b.getRawTx(t));throw new e.NotFound("Network Not Found")}catch(e){return Promise.reject(e)}},d=function(r,t){try{if("bsv"===r)return Promise.resolve(b.getBlockByHash(t));throw new e.NotFound("Network Not Found")}catch(e){return Promise.reject(e)}},g=function(r,t){try{if("bsv"===r)return Promise.resolve(b.getBlockByHeight(t));throw new e.NotFound("Network Not Found")}catch(e){return Promise.reject(e)}},P=function(r){try{if("bsv"===r)return Promise.resolve(b.getBlockchainInfo());throw new e.NotFound("Network Not Found")}catch(e){return Promise.reject(e)}},y=Buffer.from("19HxigV4QyBv3tHpQVcUEQyq1pzZVdoAut"),w=Buffer.from("ord"),b=new l;function k(e){for(var r,n=0,o=0,i=0,u="application/octet-stream",s=Buffer.alloc(0),c=a(e.chunks.entries());!(r=c()).done;){var h,f,l=r.value,m=l[0],v=l[1];if(null!=(h=v.buf)&&h.equals(y)&&e.chunks.length>m+2)return{data:s=e.chunks[m+1].buf,type:u=e.chunks[m+2].buf.toString()};if(v.opCodeNum===t.OP_FALSE&&(n=m),v.opCodeNum===t.OP_IF&&(o=m),null!=(f=v.buf)&&f.equals(w)&&n===m-2&&o===m-1){i=m;break}}for(var p=i+1;p<e.chunks.length;p++)switch(e.chunks[p].opCodeNum){case t.OP_FALSE:for(;(null==(d=e.chunks[p+1])?void 0:d.opCodeNum)>=1&&(null==(g=e.chunks[p+1])?void 0:g.opCodeNum)<=t.OP_PUSHDATA4;){var d,g;s=Buffer.concat([s,e.chunks[p+1].buf]),p++}break;case 1:if(1!=e.chunks[p].buf[0])return;case t.OP_TRUE:u=e.chunks[p+1].buf.toString("utf8"),p++;break;case t.OP_ENDIF:return{type:u,data:s};default:return}return{type:u,data:s}}function j(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}function N(e,r,t){void 0===t&&(t=!0),r.header("Content-Type",e.type||""),e.meta&&r.header("ordfs-meta",JSON.stringify(e.meta)),t&&!e.meta&&r.header("Cache-Control","public,immutable,max-age=31536000"),r.status(200).send(e.data)}function S(r){var t=function(r,t,n){try{return Promise.resolve(j(function(){var n=r.params.pointer,o=r.params.filename;return Promise.resolve(m(n)).then(function(i){var u=JSON.parse(i.data.toString("utf8"));if(!u[o])throw new e.NotFound;return n=u[o].startsWith("ord://")?u[o].slice(6):u[o],Promise.resolve(m(n,r.query.meta)).then(function(e){N(e,t,!0)})})},function(e){n(e)}))}catch(e){return Promise.reject(e)}};r.get("/",function(e,r){try{var t,n,o=function(o){return t?o:j(function(){return Promise.resolve(m(n)).then(function(t){var n;"ord-fs/json"!==t.type||e.query.raw?N(t,r,!1):null==(n=e.res)||n.redirect("index.html")})},function(){r.render("pages/404")})},i=j(function(){return Promise.resolve(v(e.hostname)).then(function(e){n=e})},function(){r.render("pages/index"),t=1});return Promise.resolve(i&&i.then?i.then(o):o(i))}catch(e){return Promise.reject(e)}}),r.get("/v1/:network/block/latest",function(e,r,t){try{var n=j(function(){var t=r.json;return Promise.resolve(P(e.params.network)).then(function(e){t.call(r,e)})},function(e){t(e)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),r.get("/v1/:network/block/height/:height",function(e,r,t){try{var n=j(function(){var t=r.json;return Promise.resolve(g(e.params.network,parseInt(e.params.height,10))).then(function(e){t.call(r,e)})},function(e){t(e)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),r.get("/v1/:network/block/hash/:hash",function(e,r,t){try{var n=j(function(){var t=r.json;return Promise.resolve(d(e.params.network,e.params.hash)).then(function(e){t.call(r,e)})},function(e){t(e)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),r.get("/v1/:network/tx/:txid",function(e,r){try{r.set("Content-type","application/octet-stream");var t=r.send;return Promise.resolve(p(e.params.network,e.params.txid)).then(function(e){t.call(r,e)})}catch(e){return Promise.reject(e)}}),r.get("/:filename",function(r,t,n){try{var o,i=r.params.filename;return Promise.resolve(j(function(){function n(e){if(o)return e;N(s,t,a)}var u,s,a=!0,c=j(function(){return Promise.resolve(m(i,r.query.meta)).then(function(e){var t;"ord-fs/json"!==(s=e).type||r.query.raw||(null==(t=r.res)||t.redirect("/"+i+"/index.html"),o=1)})},function(t){return console.error("Outpoint Error",i,t.message),Promise.resolve(v(r.hostname)).then(function(t){return u=t,Promise.resolve(m(u)).then(function(t){var n=JSON.parse(t.data.toString("utf8"));if(!n[i])throw new e.NotFound;return u=n[i].slice(6),Promise.resolve(m(u,r.query.meta)).then(function(e){s=e,a=!1})})})});return c&&c.then?c.then(n):n(c)},function(e){n(e)}))}catch(e){return Promise.reject(e)}}),r.get("/content/:pointer",function(e,r,t){try{var n=e.params.pointer;return Promise.resolve(j(function(){return Promise.resolve(m(n,e.query.meta)).then(function(t){var o;"ord-fs/json"!==t.type||e.query.raw?N(t,r,!0):null==(o=e.res)||o.redirect("/"+n+"/index.html")})},function(e){t(e)}))}catch(e){return Promise.reject(e)}}),r.get("/preview/:b64HtmlData",function(e,r,t){try{try{var n=Buffer.from(e.params.b64HtmlData,"base64").toString("utf8");r.render("pages/preview",{htmlData:n})}catch(e){t(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}}),r.get("/:pointer/:filename",t),r.get("/content/:pointer/:filename",t)}export{S as RegisterRoutes,d as getBlockByHash,g as getBlockByHeight,P as getLatestBlock,p as getRawTx,m as loadInscription,v as loadPointerFromDNS,k as parseScript};
//# sourceMappingURL=index.module.js.map
