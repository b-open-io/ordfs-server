import t from"http-errors";import{Tx as e,Script as o,OpCode as a}from"@ts-bitcoin/core";import{Transaction as n}from"bitcore-lib";import*as r from"dns/promises";import s from"cross-fetch";import{JungleBusClient as c}from"@gorillapool/js-junglebus";import*as i from"bitcoin-core";import{Redis as h}from"ioredis";let u;if(process.env.REDIS_HOST){const t=process.env.REDIS_HOST,e=process.env.REDIS_PORT?parseInt(process.env.REDIS_PORT,10):6379;console.log("Connecting to redis:",t,e),u=new h(e,t)}class l{constructor(t,e,o,a,n){this.network=void 0,this.client=void 0,this.network=t,this.client=new i({host:e,port:o,username:a,password:n})}async getRawTx(e){var o;let a=await(null==(o=u)?void 0:o.getBuffer(`rawtx:${e}`));if(!a){var n;if(a=await this.client.getTransactionByHash(e,{extension:"bin"}),!a)throw new t.NotFound;null==(n=u)||n.set(`rawtx:${e}`,a)}return a}async getBlockchainInfo(){const t=await this.client.getBlockchainInfo();return{height:t.blocks,hash:t.bestblockhash}}async getBlockByHeight(t){return{height:t,hash:await this.client.getBlockHash(t)}}async getBlockByHash(t){return{height:(await this.client.getBlockHeader(t)).height,hash:t}}}const f=Buffer.from("19HxigV4QyBv3tHpQVcUEQyq1pzZVdoAut"),w=Buffer.from("ord");let g=new class{constructor(){this.network="btc"}async getRawTx(e){var o;let a=await(null==(o=u)?void 0:o.getBuffer(`rawtx:${e}`));if(!a){var n;const o=await s(`https://ordinals.shruggr.cloud/v1/btc/tx/${e}`);if(!o.ok)throw t(o.status,o.statusText);a=Buffer.from(await o.arrayBuffer()),null==(n=u)||n.set(`rawtx:${e}`,a)}return a}async getBlockchainInfo(){const e=await s("https://ordinals.shruggr.cloud/v1/btc/block/latest");if(!e.ok)throw t(e.status,e.statusText);return e.json()}async getBlockByHeight(t){const e=await s(`https://ordinals.shruggr.cloud/v1/btc/block/height/${t}`);return{height:t,hash:(await e.json()).hash}}async getBlockByHash(t){const e=await s(`https://ordinals.shruggr.cloud/v1/btc/block/hash/${t}`);return{height:(await e.json()).height,hash:t}}},p=new class{constructor(){this.network="bsv"}async getRawTx(t){var e;let o=await(null==(e=u)?void 0:e.getBuffer(`rawtx:${t}`));if(!o){var a;const e=new c("https://junglebus.gorillapool.io"),n=await e.GetTransaction(t);o=Buffer.from(n.transaction,"base64"),null==(a=u)||a.set(`rawtx:${t}`,o)}return o}async getBlockchainInfo(){const e=await s("https://api.whatsonchain.com/v1/bsv/main/block/headers");if(!e.ok)throw t(e.status,e.statusText);const o=await e.json();return{height:o[0].height,hash:o[0].hash}}async getBlockByHeight(t){const e=await s(`https://api.whatsonchain.com/v1/bsv/main/block/height/${t}`);return{height:t,hash:(await e.json()).hash}}async getBlockByHash(t){const e=await s(`https://api.whatsonchain.com/v1/bsv/main/block/hash/${t}`);return{height:(await e.json()).height,hash:t}}};async function d(e){switch(e){case"btc":return g.getBlockchainInfo();case"bsv":return p.getBlockchainInfo();default:throw new t.NotFound("Network Not Found")}}async function m(e,o){switch(e){case"btc":return g.getBlockByHeight(o);case"bsv":return p.getBlockByHeight(o);default:throw new t.NotFound("Network Not Found")}}async function y(e,o){switch(e){case"btc":return g.getBlockByHash(o);case"bsv":return p.getBlockByHash(o);default:throw new t.NotFound("Network Not Found")}}async function k(e,o){switch(e){case"btc":return g.getRawTx(o);case"bsv":return p.getRawTx(o);default:throw new t.NotFound("Network Not Found")}}async function v(e){const o=`_ordfs.${e}`,a=await r.resolveTxt(o);let n="";console.log("Lookup Up:",o);t:for(const e of a){for(const t of e)if(t.startsWith("ordfs=")){console.log("Elem:",t),n=t.slice(6),console.log("Origin:",n);break t}if(!n)throw new t.NotFound}return n}async function B(a,r=!1){let c;if(console.log("loadInscription",a),a.match(/^[0-9a-fA-F]{64}_\d*$/)){const[o,n]=a.split("_");console.log("BSV:",o,n);const i=await p.getRawTx(o);if(!i)throw new Error("No raw tx found");const h=e.fromBuffer(i),u=parseInt(n,10),l=h.txOuts[u].script;if(!l)throw new t.NotFound;if(c=b(l),c&&r)try{const t=`https://ordinals.gorillapool.io/api/inscriptions/outpoint/${a}`,e=await s(t),n=await e.json(),{hash:r}=await p.getBlockByHeight(n.height);c.meta={height:n.height,MAP:n.MAP,hash:r,txid:o,v:u}}catch(t){}}else{if(!a.match(/^[0-9a-fA-F]{64}i\d+$/)||!g)throw new Error("Invalid Pointer");{const[e,r]=a.split("i");console.log("BTC",e,r);const s=await g.getRawTx(e);if(!s)throw new Error("No raw tx found");const i=new n(s),h=o.fromBuffer(i.inputs[parseInt(r,10)].witnesses[1]);if(!h)throw new t.NotFound;c=b(h)}}if(!c)throw new t.NotFound;return c}function b(t){let e=0,o=0,n=0,r="application/octet-stream",s=Buffer.alloc(0);for(const[h,u]of t.chunks.entries()){var c,i;if(null!=(c=u.buf)&&c.equals(f)&&t.chunks.length>h+2)return s=t.chunks[h+1].buf,r=t.chunks[h+2].buf.toString(),{data:s,type:r};if(u.opCodeNum===a.OP_FALSE&&(e=h),u.opCodeNum===a.OP_IF&&(o=h),null!=(i=u.buf)&&i.equals(w)&&e===h-2&&o===h-1){n=h;break}}for(let e=n+1;e<t.chunks.length;e++)switch(t.chunks[e].opCodeNum){case a.OP_FALSE:for(;(null==(h=t.chunks[e+1])?void 0:h.opCodeNum)>=1&&(null==(u=t.chunks[e+1])?void 0:u.opCodeNum)<=a.OP_PUSHDATA4;){var h,u;s=Buffer.concat([s,t.chunks[e+1].buf]),e++}break;case 1:if(1!=t.chunks[e].buf[0])return;case a.OP_TRUE:r=t.chunks[e+1].buf.toString("utf8"),e++;break;case a.OP_ENDIF:return{type:r,data:s};default:return}return{type:r,data:s}}function T(t,e,o=!0){e.header("Content-Type",t.type||""),t.meta&&e.header("ordfs-meta",JSON.stringify(t.meta)),o&&!t.meta&&e.header("Cache-Control","public,immutable,max-age=31536000"),e.status(200).send(t.data)}function N(e){async function o(e,o,a){try{let a=e.params.pointer;const n=e.params.filename,r=await B(a),s=JSON.parse(r.data.toString("utf8"));if(!s[n])throw new t.NotFound;a=s[n].startsWith("ord://")?s[n].slice(6):s[n],T(await B(a,e.query.meta),o,!0)}catch(t){a(t)}}e.get("/",async(t,e)=>{let o;try{o=await v(t.hostname)}catch(t){return void e.render("pages/index")}try{const n=await B(o);var a;if("ord-fs/json"===n.type&&!t.query.raw)return void(null==(a=t.res)||a.redirect("index.html"));T(n,e,!1)}catch(t){e.render("pages/404")}}),e.get("/v1/:network/block/latest",async(t,e,o)=>{try{e.json(await d(t.params.network))}catch(t){o(t)}}),e.get("/v1/:network/block/height/:height",async(t,e,o)=>{try{e.json(await m(t.params.network,parseInt(t.params.height,10)))}catch(t){o(t)}}),e.get("/v1/:network/block/hash/:hash",async(t,e,o)=>{try{e.json(await y(t.params.network,t.params.hash))}catch(t){o(t)}}),e.get("/v1/:network/tx/:txid",async(t,e)=>{e.set("Content-type","application/octet-stream"),e.send(await k(t.params.network,t.params.txid))}),e.get("/:filename",async function(e,o,a){const n=e.params.filename;try{let a,s,c=!0;try{var r;if(s=await B(n,e.query.meta),"ord-fs/json"===s.type&&!e.query.raw)return void(null==(r=e.res)||r.redirect(`/${n}/index.html`))}catch(o){console.error("Outpoint Error",n,o.message),a=await v(e.hostname);const r=await B(a),i=JSON.parse(r.data.toString("utf8"));if(!i[n])throw new t.NotFound;a=i[n].slice(6),s=await B(a,e.query.meta),c=!1}T(s,o,c)}catch(t){a(t)}}),e.get("/content/:pointer",async function(t,e,o){const a=t.params.pointer;try{const o=await B(a,t.query.meta);var n;if("ord-fs/json"===o.type&&!t.query.raw)return void(null==(n=t.res)||n.redirect(`/${a}/index.html`));T(o,e,!0)}catch(t){o(t)}}),e.get("/preview/:b64HtmlData",async function(t,e,o){try{const o=Buffer.from(t.params.b64HtmlData,"base64").toString("utf8");e.render("pages/preview",{htmlData:o})}catch(t){o(t)}}),e.get("/:pointer/:filename",o),e.get("/content/:pointer/:filename",o)}process.env.BITCOIN_HOST&&(p=new l("bsv",process.env.BITCOIN_HOST||"",process.env.BITCOIN_PORT||"8332",process.env.BITCOIN_USER||"",process.env.BITCOIN_PASS||"")),process.env.BTC_HOST&&(g=new l("btc",process.env.BTC_HOST||"",process.env.BTC_PORT||"8332",process.env.BTC_USER||"",process.env.BTC_PASS||""));export{N as RegisterRoutes,y as getBlockByHash,m as getBlockByHeight,d as getLatestBlock,k as getRawTx,B as loadInscription,v as loadPointerFromDNS,b as parseScript};
//# sourceMappingURL=index.modern.js.map
