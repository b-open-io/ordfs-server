import t,{NotFound as e}from"http-errors";import{Tx as a,Script as o,OpCode as n}from"@ts-bitcoin/core";import{Transaction as r}from"bitcore-lib";import*as s from"dns/promises";import c from"cross-fetch";import{JungleBusClient as i}from"@gorillapool/js-junglebus";import*as h from"bitcoin-core";import{Redis as l}from"ioredis";let u;if(process.env.REDIS_HOST){const t=process.env.REDIS_HOST,e=process.env.REDIS_PORT?parseInt(process.env.REDIS_PORT,10):6379;console.log("Connecting to redis:",t,e),u=new l(e,t)}class f{constructor(t,e,a,o,n){this.network=void 0,this.client=void 0,this.network=t,this.client=new h({host:e,port:a,username:o,password:n})}async getRawTx(t){var a;let o=await(null==(a=u)?void 0:a.getBuffer(`rawtx:${t}`));if(!o){var n;if(o=await this.client.getTransactionByHash(t,{extension:"bin"}),!o)throw new e;null==(n=u)||n.set(`rawtx:${t}`,o)}return o}async getBlockchainInfo(){const t=await this.client.getBlockchainInfo();return{height:t.blocks,hash:t.bestblockhash}}async getBlockByHeight(t){return{height:t,hash:await this.client.getBlockHash(t)}}async getBlockByHash(t){return{height:(await this.client.getBlockHeader(t)).height,hash:t}}}const w=Buffer.from("19HxigV4QyBv3tHpQVcUEQyq1pzZVdoAut"),g=Buffer.from("ord");let p=new class{constructor(){this.network="btc"}async getRawTx(e){var a;let o=await(null==(a=u)?void 0:a.getBuffer(`rawtx:${e}`));if(!o){var n;const a=await c(`https://ordinals.shruggr.cloud/v1/btc/tx/${e}`);if(!a.ok)throw t(a.status,a.statusText);o=Buffer.from(await a.arrayBuffer()),null==(n=u)||n.set(`rawtx:${e}`,o)}return o}async getBlockchainInfo(){const e=await c("https://ordinals.shruggr.cloud/v1/btc/block/latest");if(!e.ok)throw t(e.status,e.statusText);return e.json()}async getBlockByHeight(t){const e=await c(`https://ordinals.shruggr.cloud/v1/btc/block/height/${t}`);return{height:t,hash:(await e.json()).hash}}async getBlockByHash(t){const e=await c(`https://ordinals.shruggr.cloud/v1/btc/block/hash/${t}`);return{height:(await e.json()).height,hash:t}}},d=new class{constructor(){this.network="bsv"}async getRawTx(t){var e;let a=await(null==(e=u)?void 0:e.getBuffer(`rawtx:${t}`));if(!a){var o;const e=new i("https://junglebus.gorillapool.io"),n=await e.GetTransaction(t);a=Buffer.from(n.transaction,"base64"),null==(o=u)||o.set(`rawtx:${t}`,a)}return a}async getBlockchainInfo(){const e=await c("https://api.whatsonchain.com/v1/bsv/main/block/headers");if(!e.ok)throw t(e.status,e.statusText);const a=await e.json();return{height:a[0].height,hash:a[0].hash}}async getBlockByHeight(t){const e=await c(`https://api.whatsonchain.com/v1/bsv/main/block/height/${t}`);return{height:t,hash:(await e.json()).hash}}async getBlockByHash(t){const e=await c(`https://api.whatsonchain.com/v1/bsv/main/block/hash/${t}`);return{height:(await e.json()).height,hash:t}}};async function m(t){switch(t){case"btc":return p.getBlockchainInfo();case"bsv":return d.getBlockchainInfo();default:throw new e("Network Not Found")}}async function y(t,a){switch(t){case"btc":return p.getBlockByHeight(a);case"bsv":return d.getBlockByHeight(a);default:throw new e("Network Not Found")}}async function k(t,a){switch(t){case"btc":return p.getBlockByHash(a);case"bsv":return d.getBlockByHash(a);default:throw new e("Network Not Found")}}async function v(t,a){switch(t){case"btc":return p.getRawTx(a);case"bsv":return d.getRawTx(a);default:throw new e("Network Not Found")}}async function B(t){const a=`_ordfs.${t}`,o=await s.resolveTxt(a);let n="";console.log("Lookup Up:",a);t:for(const t of o){for(const e of t)if(e.startsWith("ordfs=")){console.log("Elem:",e),n=e.slice(6),console.log("Origin:",n);break t}if(!n)throw new e}return n}async function b(t,n=!1){let s;if(console.log("loadInscription",t),t.match(/^[0-9a-fA-F]{64}_\d*$/)){const[o,r]=t.split("_");console.log("BSV:",o,r);const i=await d.getRawTx(o);if(!i)throw new Error("No raw tx found");const h=a.fromBuffer(i),l=parseInt(r,10),u=h.txOuts[l].script;if(!u)throw new e;if(s=T(u),s&&n)try{const e=`https://ordinals.gorillapool.io/api/inscriptions/outpoint/${t}`,a=await c(e),n=await a.json(),{hash:r}=await d.getBlockByHeight(n.height);s.meta={height:n.height,MAP:n.MAP,hash:r,txid:o,v:l}}catch(t){}}else{if(!t.match(/^[0-9a-fA-F]{64}i\d+$/)||!p)throw new Error("Invalid Pointer");{const[a,n]=t.split("i");console.log("BTC",a,n);const c=await p.getRawTx(a);if(!c)throw new Error("No raw tx found");const i=new r(c),h=o.fromBuffer(i.inputs[parseInt(n,10)].witnesses[1]);if(!h)throw new e;s=T(h)}}if(!s)throw new e;return s}function T(t){let e=0,a=0,o=0,r="application/octet-stream",s=Buffer.alloc(0);for(const[h,l]of t.chunks.entries()){var c,i;if(null!=(c=l.buf)&&c.equals(w)&&t.chunks.length>h+2)return s=t.chunks[h+1].buf,r=t.chunks[h+2].buf.toString(),{data:s,type:r};if(l.opCodeNum===n.OP_FALSE&&(e=h),l.opCodeNum===n.OP_IF&&(a=h),null!=(i=l.buf)&&i.equals(g)&&e===h-2&&a===h-1){o=h;break}}for(let e=o+1;e<t.chunks.length;e++)switch(t.chunks[e].opCodeNum){case n.OP_FALSE:for(;(null==(h=t.chunks[e+1])?void 0:h.opCodeNum)>=1&&(null==(l=t.chunks[e+1])?void 0:l.opCodeNum)<=n.OP_PUSHDATA4;){var h,l;s=Buffer.concat([s,t.chunks[e+1].buf]),e++}break;case 1:if(1!=t.chunks[e].buf[0])return;case n.OP_TRUE:r=t.chunks[e+1].buf.toString("utf8"),e++;break;case n.OP_ENDIF:return{type:r,data:s};default:return}return{type:r,data:s}}function x(t,e,a=!0){e.header("Content-Type",t.type||""),t.meta&&e.header("ordfs-meta",JSON.stringify(t.meta)),a&&!t.meta&&e.header("Cache-Control","public,immutable,max-age=31536000"),e.status(200).send(t.data)}function I(t){async function a(t,a,o){try{let o=t.params.pointer;const n=t.params.filename,r=await b(o),s=JSON.parse(r.data.toString("utf8"));if(!s[n])throw new e;o=s[n].startsWith("ord://")?s[n].slice(6):s[n],x(await b(o,t.query.meta),a,!0)}catch(t){o(t)}}t.get("/",async(t,e)=>{let a;try{a=await B(t.hostname)}catch(t){return void e.render("pages/index")}try{const n=await b(a);var o;if("ord-fs/json"===n.type&&!t.query.raw)return void(null==(o=t.res)||o.redirect("index.html"));x(n,e,!1)}catch(t){e.render("pages/404")}}),t.get("/v1/:network/block/latest",async(t,e,a)=>{try{e.json(await m(t.params.network))}catch(t){a(t)}}),t.get("/v1/:network/block/height/:height",async(t,e,a)=>{try{e.json(await y(t.params.network,parseInt(t.params.height,10)))}catch(t){a(t)}}),t.get("/v1/:network/block/hash/:hash",async(t,e,a)=>{try{e.json(await k(t.params.network,t.params.hash))}catch(t){a(t)}}),t.get("/v1/:network/tx/:txid",async(t,e)=>{e.set("Content-type","application/octet-stream"),e.send(await v(t.params.network,t.params.txid))}),t.get("/:filename",async function(t,a,o){const n=t.params.filename;try{let o,s,c=!0;try{var r;if(s=await b(n,t.query.meta),"ord-fs/json"===s.type&&!t.query.raw)return void(null==(r=t.res)||r.redirect(`/${n}/index.html`))}catch(a){console.error("Outpoint Error",n,a.message),o=await B(t.hostname);const r=await b(o),i=JSON.parse(r.data.toString("utf8"));if(!i[n])throw new e;o=i[n].slice(6),s=await b(o,t.query.meta),c=!1}x(s,a,c)}catch(t){o(t)}}),t.get("/content/:pointer",async function(t,e,a){const o=t.params.pointer;try{const a=await b(o,t.query.meta);var n;if("ord-fs/json"===a.type&&!t.query.raw)return void(null==(n=t.res)||n.redirect(`/${o}/index.html`));x(a,e,!0)}catch(t){a(t)}}),t.get("/preview/:b64HtmlData",async function(t,e,a){try{const a=Buffer.from(t.params.b64HtmlData,"base64").toString("utf8");e.render("pages/preview",{htmlData:a})}catch(t){a(t)}}),t.get("/:pointer/:filename",a),t.get("/content/:pointer/:filename",a)}process.env.BITCOIN_HOST&&(d=new f("bsv",process.env.BITCOIN_HOST||"",process.env.BITCOIN_PORT||"8332",process.env.BITCOIN_USER||"",process.env.BITCOIN_PASS||"")),process.env.BTC_HOST&&(p=new f("btc",process.env.BTC_HOST||"",process.env.BTC_PORT||"8332",process.env.BTC_USER||"",process.env.BTC_PASS||""));export{I as RegisterRoutes,k as getBlockByHash,y as getBlockByHeight,m as getLatestBlock,v as getRawTx,b as loadInscription,B as loadPointerFromDNS,T as parseScript};
//# sourceMappingURL=index.modern.js.map
